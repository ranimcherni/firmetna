{% extends 'admin_base.html.twig' %}

{% block title %}Tableau de bord - FIRMETNA{% endblock %}

{% block body %}
<div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h2 class="fw-bold fs-3 mb-1">Tableau de Bord Analytique</h2>
        <p class="text-muted">Statistiques en temps réel et indicateurs de performance</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-white shadow-sm rounded-pill px-3 border"><i class="fas fa-download me-2"></i>Exporter PDF</button>
        <button class="btn btn-success shadow-sm rounded-pill px-3 border-0" style="background-color: #1a4d2e;"><i class="fas fa-sync me-2"></i>Actualiser</button>
    </div>
</div>

<!-- Statistiques des Modules (Gestions) -->
<div class="row g-4 mb-4">
    <div class="col-md-4 col-lg-2">
        <div class="card border-0 shadow-sm text-center p-3" style="border-radius: 20px; background: #f8fafc;">
            <i class="fas fa-users fa-2x text-primary mb-2"></i>
            <h3 class="fw-bold mb-0 text-dark">{{ totalUsers }}</h3>
            <span class="text-muted small fw-semibold">Utilisateurs</span>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="card border-0 shadow-sm text-center p-3" style="border-radius: 20px; background: #f8fafc;">
            <i class="fas fa-shopping-basket fa-2x text-success mb-2"></i>
            <h3 class="fw-bold mb-0 text-dark">{{ produitsCount }}</h3>
            <span class="text-muted small fw-semibold">Produits</span>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="card border-0 shadow-sm text-center p-3" style="border-radius: 20px; background: #f8fafc;">
            <i class="fas fa-calendar-alt fa-2x text-warning mb-2"></i>
            <h3 class="fw-bold mb-0 text-dark">{{ eventsCount }}</h3>
            <span class="text-muted small fw-semibold">Événements</span>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="card border-0 shadow-sm text-center p-3" style="border-radius: 20px; background: #f8fafc;">
            <i class="fas fa-comments fa-2x text-info mb-2"></i>
            <h3 class="fw-bold mb-0 text-dark">{{ publicationsCount }}</h3>
            <span class="text-muted small fw-semibold">Forum</span>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="card border-0 shadow-sm text-center p-3" style="border-radius: 20px; background: #f8fafc;">
            <i class="fas fa-handshake fa-2x text-indigo mb-2" style="color: #4f46e5;"></i>
            <h3 class="fw-bold mb-0 text-dark">{{ partnersCount }}</h3>
            <span class="text-muted small fw-semibold">Partenaires</span>
        </div>
    </div>
    <div class="col-md-4 col-lg-2">
        <div class="card border-0 shadow-sm text-center p-3" style="border-radius: 20px; background: #f8fafc;">
            <i class="fas fa-file-contract fa-2x text-danger mb-2"></i>
            <h3 class="fw-bold mb-0 text-dark">{{ contractsCount }}</h3>
            <span class="text-muted small fw-semibold">Contrats</span>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- Distribution Utilisateurs -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100" style="border-radius: 24px;">
            <div class="card-body p-4 text-center">
                <h5 class="fw-bold mb-4"><i class="fas fa-users me-2 text-primary"></i>Utilisateurs</h5>
                <div style="height: 200px;">
                    <canvas id="userDistributionChart"></canvas>
                </div>
                <div class="mt-3 d-flex flex-column gap-2 text-start">
                    <div class="small fw-bold"><i class="fas fa-circle me-2" style="color: #1a4d2e;"></i>Agriculteurs: {{ agriculteursCount }}</div>
                    <div class="small fw-bold"><i class="fas fa-circle me-2" style="color: #fbbf24;"></i>Clients: {{ clientsCount }}</div>
                    <div class="small fw-bold"><i class="fas fa-circle me-2" style="color: #2e7d32;"></i>Donateurs: {{ donateursCount }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Distribution Produits -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100" style="border-radius: 24px;">
            <div class="card-body p-4 text-center">
                <h5 class="fw-bold mb-4"><i class="fas fa-box me-2 text-success"></i>Produits</h5>
                <div style="height: 200px;">
                    <canvas id="productDistributionChart"></canvas>
                </div>
                <div class="mt-3 d-flex flex-column gap-2 text-start">
                    <div class="small fw-bold"><i class="fas fa-circle me-2" style="color: #10b981;"></i>Végétal: {{ stats.vegetal }}</div>
                    <div class="small fw-bold"><i class="fas fa-circle me-2" style="color: #ef4444;"></i>Animal: {{ stats.animale }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Produits (Visuel) -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100" style="border-radius: 24px;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0"><i class="fas fa-star me-2 text-warning"></i>Phare</h5>
                    <a href="{{ path('app_admin_produits') }}" class="btn btn-link text-success text-decoration-none fw-bold p-0 small">Voir tout</a>
                </div>
                
                <div class="row g-2">
                    {% for product in topProducts %}
                    <div class="col-12">
                        <div class="p-2 border rounded-4 d-flex align-items-center bg-white">
                            <img src="{{ product.image }}" class="rounded-3 me-2" style="width: 45px; height: 45px; object-fit: cover;">
                            <div class="flex-grow-1 min-width-0">
                                <h6 class="fw-bold mb-0 text-truncate" style="font-size: 0.85rem;">{{ product.name }}</h6>
                                <span class="badge {% if 'Vegetal' in product.category %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} rounded-pill px-2" style="font-size: 0.6rem;">{{ product.category }}</span>
                            </div>
                            <div class="text-end ms-2">
                                <div class="fw-bold text-dark" style="font-size: 0.75rem;">{{ product.sales }}</div>
                                <div class="small text-success fw-bold" style="font-size: 0.65rem;">{{ product.growth }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Évolution de l'Activité (Courbe) -->
    <div class="col-12">
        <div class="card border-0 shadow-sm" style="border-radius: 24px;">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0 text-success"><i class="fas fa-chart-line me-2"></i>Activité globale</h5>
                </div>
                <div style="height: 250px;">
                    <canvas id="activityCurveChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 1. User Distribution Chart
    const ctxUser = document.getElementById('userDistributionChart').getContext('2d');
    new Chart(ctxUser, {
        type: 'doughnut',
        data: {
            labels: ['Agriculteurs', 'Clients', 'Donateurs'],
            datasets: [{
                data: [{{ agriculteursCount }}, {{ clientsCount }}, {{ donateursCount }}],
                backgroundColor: ['#1a4d2e', '#fbbf24', '#2e7d32'],
                borderWidth: 0,
                cutout: '70%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });

    // 2. Product Distribution Chart
    const ctxProduct = document.getElementById('productDistributionChart').getContext('2d');
    new Chart(ctxProduct, {
        type: 'doughnut',
        data: {
            labels: ['Végétal', 'Animal'],
            datasets: [{
                data: [{{ stats.vegetal }}, {{ stats.animale }}],
                backgroundColor: ['#10b981', '#ef4444'],
                borderWidth: 0,
                cutout: '70%'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });

    // 3. Activity Curve Chart
    const ctxCurve = document.getElementById('activityCurveChart').getContext('2d');
    new Chart(ctxCurve, {
        type: 'line',
        data: {
            labels: ['Jan', 'Féb', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil'],
            datasets: [{
                label: 'Interactions',
                data: {{ monthlySales|json_encode|raw }},
                borderColor: '#1a4d2e',
                backgroundColor: 'rgba(26, 77, 46, 0.05)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { display: false },
                x: { grid: { display: false } }
            }
        }
    });
});
</script>
{% endblock %}
