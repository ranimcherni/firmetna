{% extends 'admin_base.html.twig' %}

{% block title %}Ajouter un Lieu - FIRMETNA{% endblock %}

{% block body %}
<div class="mb-4">
    <a href="{{ path('app_admin_lieu_index') }}" class="text-decoration-none text-muted">
        <i class="fas fa-arrow-left me-1"></i> Retour à la liste
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm" style="border-radius: 12px;">
            <div class="card-body p-4">
                <h2 class="fw-bold mb-4">Ajouter un nouveau lieu</h2>
                <p class="text-muted mb-4">Remplissez les informations ci-dessous pour créer un nouveau lieu d'évènement.</p>

                {{ form_start(form) }}
                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.ville) }}
                            {{ form_errors(form.ville) }}
                            {{ form_widget(form.ville, {'attr': {'placeholder': 'Ex: Tunis', 'class': 'form-control'}}) }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.adresse) }}
                            {{ form_errors(form.adresse) }}
                            {{ form_widget(form.adresse, {'attr': {'placeholder': 'Ex: Avenue Habib Bourguiba', 'class': 'form-control'}}) }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.capacite) }}
                            {{ form_errors(form.capacite) }}
                            {{ form_widget(form.capacite, {'attr': {'placeholder': 'Ex: 100', 'class': 'form-control'}}) }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.imageFile) }}
                            {{ form_errors(form.imageFile) }}
                            {{ form_widget(form.imageFile, {'attr': {'class': 'form-control'}}) }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.disponibilite) }}
                            {{ form_errors(form.disponibilite) }}
                            {{ form_widget(form.disponibilite, {'attr': {'class': 'form-select'}}) }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form_label(form.description) }}
                            {{ form_errors(form.description) }}
                            {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 4}}) }}
                        </div>
                        <div class="col-12 mb-3">
                            {{ form_widget(form.latitude) }}
                            {{ form_widget(form.longitude) }}
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold mb-2">
                            <i class="fas fa-map-marker-alt me-2"></i>Position sur la carte
                        </label>
                        <p class="text-muted small mb-2">Cliquez sur la carte pour définir la position du lieu, ou laissez vide pour géocodage automatique.</p>
                        <div id="map" style="height: 400px; border-radius: 8px; border: 1px solid #dee2e6;"></div>
                    </div>

                    <div class="mt-4 pt-4 border-top">
                        <button type="submit" class="btn btn-success px-5 py-2" style="background-color: #1a4d2e; border: none; border-radius: 8px;">
                            <i class="fas fa-save me-2"></i> Enregistrer le lieu
                        </button>
                    </div>
                {{ form_end(form) }}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Initialiser la carte Leaflet
    const map = L.map('map').setView([36.8065, 10.1815], 13); // Centre sur Tunis par défaut

    // Ajouter les tuiles OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);

    let marker = null;
    const latInput = document.getElementById('lieu_latitude');
    const lonInput = document.getElementById('lieu_longitude');

    // Si des coordonnées existent déjà, placer le marqueur
    if (latInput.value && lonInput.value) {
        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);
        map.setView([lat, lon], 15);
        marker = L.marker([lat, lon]).addTo(map);
    }

    // Gérer le clic sur la carte
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;
        
        // Mettre à jour les champs cachés
        latInput.value = lat.toFixed(8);
        lonInput.value = lon.toFixed(8);
        
        // Mettre à jour ou créer le marqueur
        if (marker) {
            marker.setLatLng([lat, lon]);
        } else {
            marker = L.marker([lat, lon]).addTo(map);
        }

        // Géocodage inversé : récupérer l'adresse depuis les coordonnées
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`, {
            headers: { 'User-Agent': 'FIRMETNA/1.0' }
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.address) {
                const addr = data.address;
                // Remplir le champ adresse
                const road = addr.road || addr.pedestrian || addr.neighbourhood || addr.suburb || '';
                const houseNumber = addr.house_number || '';
                const fullAddress = houseNumber ? houseNumber + ' ' + road : road;
                if (adresseInput && fullAddress) {
                    adresseInput.value = fullAddress;
                }
                // Remplir le champ ville
                const city = addr.city || addr.town || addr.village || addr.municipality || addr.state || '';
                if (villeInput && city) {
                    villeInput.value = city;
                }
            }
        })
        .catch(err => console.error('Erreur géocodage inversé:', err));
    });

    // Bouton pour géocoder depuis l'adresse
    const adresseInput = document.querySelector('input[name="lieu[adresse]"]');
    const villeInput = document.querySelector('input[name="lieu[ville]"]');
    
    // Créer un bouton de géocodage
    const geocodeBtn = document.createElement('button');
    geocodeBtn.type = 'button';
    geocodeBtn.className = 'btn btn-outline-primary btn-sm mt-2';
    geocodeBtn.innerHTML = '<i class="fas fa-search-location me-1"></i> Trouver sur la carte';
    geocodeBtn.onclick = function() {
        const adresse = adresseInput.value.trim();
        const ville = villeInput.value.trim();
        if (adresse || ville) {
            geocodeBtn.disabled = true;
            geocodeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Recherche...';
            
            const query = (adresse ? adresse + ', ' : '') + (ville ? ville : '') + ', Tunisia';
            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&addressdetails=1`, {
                headers: {
                    'User-Agent': 'FIRMETNA/1.0'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat, lon], 15);
                    if (marker) {
                        marker.setLatLng([lat, lon]);
                    } else {
                        marker = L.marker([lat, lon]).addTo(map);
                    }
                    latInput.value = lat.toFixed(8);
                    lonInput.value = lon.toFixed(8);
                } else {
                    alert('Adresse non trouvée. Cliquez directement sur la carte pour définir la position.');
                }
            })
            .catch(err => {
                console.error('Erreur géocodage:', err);
                alert('Erreur lors de la recherche. Cliquez directement sur la carte.');
            })
            .finally(() => {
                geocodeBtn.disabled = false;
                geocodeBtn.innerHTML = '<i class="fas fa-search-location me-1"></i> Trouver sur la carte';
            });
        } else {
            alert('Veuillez remplir au moins l\'adresse ou la ville.');
        }
    };
    
    if (adresseInput && villeInput) {
        const adresseContainer = adresseInput.closest('.col-md-6');
        if (adresseContainer) {
            adresseContainer.appendChild(geocodeBtn);
        }
    }
</script>
{% endblock %}
