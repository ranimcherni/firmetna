{% extends 'base.html.twig' %}

{% block title %}Dons & Aide - FIRMETNA{% endblock %}

{% block body %}
<style>
    .dons-hero {
        background: linear-gradient(rgba(26, 77, 46, 0.85), rgba(26, 77, 46, 0.85)), url('{{ asset('images/vert.png') }}');
        background-size: cover;
        background-position: center;
        color: white;
        padding: 4rem 0;
        border-radius: 0 0 2rem 2rem;
        margin-bottom: 2rem;
    }
    .form-card {
        background: white;
        border-radius: 1.25rem;
        box-shadow: 0 10px 40px rgba(26, 77, 46, 0.08);
        border: 1px solid rgba(26, 77, 46, 0.1);
        overflow: hidden;
    }
    .btn-publier {
        background: #1a4d2e;
        color: white !important;
        border: none;
        padding: 0.85rem 2.5rem;
        font-weight: 700;
        border-radius: 50px;
        font-size: 1.05rem;
        transition: all 0.3s;
    }
    .btn-publier:hover {
        background: #23613a;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(26, 77, 46, 0.35);
        color: white !important;
    }
    .section-title {
        color: #1a4d2e;
        font-weight: 800;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 3px solid #1a4d2e;
        display: inline-block;
    }
    .produit-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        border: 1px solid #e8f5e9;
        overflow: hidden;
        transition: all 0.3s;
        height: 100%;
    }
    .produit-card:hover {
        box-shadow: 0 12px 30px rgba(26, 77, 46, 0.12);
        transform: translateY(-4px);
    }
    .produit-card .img-wrap {
        height: 180px;
        background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .produit-card .img-wrap img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .badge-dispo { background: #2e7d32; color: white; }
    .badge-non-dispo { background: #c62828; color: white; }
    .btn-demander {
        background: #1a4d2e;
        color: white !important;
        border: none;
        padding: 0.5rem 1.25rem;
        font-weight: 600;
        border-radius: 50px;
        font-size: 0.9rem;
        transition: all 0.3s;
    }
    .btn-demander:hover {
        background: #23613a;
        color: white !important;
        transform: scale(1.03);
    }
    .btn-demander:disabled, .btn-demander.disabled {
        background: #9e9e9e;
        cursor: not-allowed;
        transform: none;
    }
    .form-control:focus, .form-select:focus {
        border-color: #1a4d2e;
        box-shadow: 0 0 0 0.2rem rgba(26, 77, 46, 0.2);
    }
    .produit-dispo-card-dons {
        border-radius: 1rem;
        border: 1px solid #e8f5e9;
        transition: all 0.3s;
    }
    .produit-dispo-card-dons:hover {
        box-shadow: 0 12px 30px rgba(26, 77, 46, 0.12) !important;
        transform: translateY(-4px);
    }
</style>

<div class="dons-hero">
    <div class="container text-center">
        <h1 class="display-5 fw-bold mb-2"><i class="fas fa-hand-holding-heart me-2"></i>Dons & Aide</h1>
        <p class="lead mb-0 opacity-90">Publiez une offre ou demandez un produit pour soutenir les agriculteurs.</p>
    </div>
</div>

<div class="container pb-5">
    <div class="row g-4">
        {# ----- Gauche : Offres des donateurs ----- #}
        <div class="col-lg-8 order-2 order-lg-1">
            <h2 class="section-title mt-0" id="produits-liste"><i class="fas fa-list me-2"></i>Offres des donateurs</h2>
            <p class="text-muted mb-4">Offres publiées par les donateurs. Cliquez sur « Demander » si vous êtes un agriculteur dans le besoin.</p>

            {% if offres|length == 0 %}
                <div class="alert alert-light border text-center py-5">
                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                    <p class="mb-0 text-muted">Aucune offre pour le moment. Soyez le premier à publier une offre de don.</p>
                </div>
            {% else %}
                <div class="row g-4">
                    {% for offre in offres %}
                        <div class="col-sm-6 col-xl-4">
                            <div class="produit-card card h-100 border-0">
                                <div class="img-wrap">
                                    {% if offre.photo %}
                                        <img src="{{ asset(offre.photo) }}" alt="{{ offre.categorie }}">
                                    {% else %}
                                        <i class="fas fa-seedling fa-4x text-success opacity-50"></i>
                                    {% endif %}
                                </div>
                                <div class="card-body">
                                    <span class="badge rounded-pill mb-2 {{ offre.disponible ? 'badge-dispo' : 'badge-non-dispo' }}">
                                        {{ offre.disponible ? 'Disponible' : 'Non disponible' }}
                                    </span>
                                    <h5 class="card-title fw-bold text-dark mb-1">{{ offre.categorie }}</h5>
                                    {% if offre.quantite %}
                                        <p class="text-muted small mb-2">{{ offre.quantite }}</p>
                                    {% endif %}
                                    <p class="card-text small text-secondary mb-3 line-clamp-2">{{ offre.description|u.truncate(80) }}</p>
                                    {% if offre.disponible and app.user %}
                                        {% if demandesByOffre[offre.id] ?? false %}
                                            <button type="button" class="btn btn-demander disabled w-100" disabled>
                                                <i class="fas fa-check me-1"></i>Déjà demandé
                                            </button>
                                        {% else %}
                                            <form action="{{ path('app_donations_demander', { id: offre.id }) }}" method="post" class="d-inline">
                                                <input type="hidden" name="_token" value="{{ csrf_token('demander_' ~ offre.id) }}">
                                                <button type="submit" class="btn btn-demander w-100">
                                                    <i class="fas fa-hand-holding-heart me-1"></i>Demander
                                                </button>
                                            </form>
                                        {% endif %}
                                    {% elseif offre.disponible and not app.user %}
                                        <a href="{{ path('app_login') }}" class="btn btn-demander w-100">
                                            <i class="fas fa-sign-in-alt me-1"></i>Se connecter pour demander
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        {# ----- Droite : Formulaire Publier une offre ----- #}
        <div class="col-lg-4 order-1 order-lg-2">
            <div class="form-card p-4">
                <h2 class="h5 fw-bold text-dark mb-4">
                    <i class="fas fa-gift text-success me-2"></i>Publier une offre de don
                </h2>
                {{ form_start(form, { 'attr': { 'class': 'row g-3' } }) }}
                    <div class="col-12">
                        {{ form_row(form.nom, { 'label_attr': { 'class': 'fw-semibold' }, 'attr': { 'class': 'form-control' } }) }}
                    </div>
                    <div class="col-12">
                        {{ form_row(form.telephone, { 'label_attr': { 'class': 'fw-semibold' }, 'attr': { 'class': 'form-control' } }) }}
                    </div>
                    <div class="col-12">
                        {{ form_row(form.categorie, { 'label_attr': { 'class': 'fw-semibold' }, 'attr': { 'class': 'form-select' } }) }}
                    </div>
                    <div class="col-12">
                        {{ form_row(form.description, { 'label_attr': { 'class': 'fw-semibold' }, 'attr': { 'class': 'form-control', 'rows': '3' } }) }}
                    </div>
                    <div class="col-12">
                        {{ form_row(form.quantite, { 'label_attr': { 'class': 'fw-semibold' }, 'attr': { 'class': 'form-control' } }) }}
                    </div>
                    <div class="col-12">
                        {{ form_row(form.photoFile, { 'label_attr': { 'class': 'fw-semibold' } }) }}
                    </div>
                    <div class="col-12 pt-2">
                        <button type="submit" class="btn btn-publier w-100">
                            <i class="fas fa-check-circle me-2"></i>PUBLIER L'OFFRE
                        </button>
                    </div>
                {{ form_end(form) }}
            </div>
        </div>
    </div>

    <hr class="my-5 opacity-10">

    {# ----- Bas : Produits disponibles ----- #}
    <h2 class="section-title"><i class="fas fa-box-open me-2"></i>Produits disponibles</h2>
    <p class="text-muted mb-4">Exemples de produits en stock. Cliquez sur « Demander » pour faire une demande.</p>
    <div class="row g-4">
        <div class="col-sm-6 col-lg-3">
            <div class="produit-dispo-card-dons card h-100 border-0 shadow-sm">
                <div class="card-icon-dons rounded-circle mx-auto mt-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: linear-gradient(135deg, #22c55e, #16a34a);">
                    <i class="fas fa-carrot fa-2x text-white"></i>
                </div>
                <div class="card-body text-center">
                    <h5 class="card-title fw-bold text-dark mb-2">Légumes</h5>
                    <p class="text-muted small mb-3">Disponible 15 kg tomates maintenant</p>
                    <a href="{{ path('app_donations_produit', { type: 'legumes' }) }}" class="btn btn-demander w-100"><i class="fas fa-hand-holding-heart me-1"></i> Demander</a>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="produit-dispo-card-dons card h-100 border-0 shadow-sm">
                <div class="card-icon-dons rounded-circle mx-auto mt-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: linear-gradient(135deg, #eab308, #ca8a04);">
                    <i class="fas fa-apple-alt fa-2x text-white"></i>
                </div>
                <div class="card-body text-center">
                    <h5 class="card-title fw-bold text-dark mb-2">Fruits</h5>
                    <p class="text-muted small mb-3">Disponible 10 kilos pommes maintenant</p>
                    <a href="{{ path('app_donations_produit', { type: 'fruits' }) }}" class="btn btn-demander w-100"><i class="fas fa-hand-holding-heart me-1"></i> Demander</a>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="produit-dispo-card-dons card h-100 border-0 shadow-sm">
                <div class="card-icon-dons rounded-circle mx-auto mt-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: linear-gradient(135deg, #1a4d2e, #23613a);">
                    <i class="fas fa-vial fa-2x text-white"></i>
                </div>
                <div class="card-body text-center">
                    <h5 class="card-title fw-bold text-dark mb-2">Engrais</h5>
                    <p class="text-muted small mb-3">Disponible 5 sacs engrais organique maintenant</p>
                    <a href="{{ path('app_donations_produit', { type: 'engrais' }) }}" class="btn btn-demander w-100"><i class="fas fa-hand-holding-heart me-1"></i> Demander</a>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="produit-dispo-card-dons card h-100 border-0 shadow-sm">
                <div class="card-icon-dons rounded-circle mx-auto mt-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; background: linear-gradient(135deg, #0d9488, #0f766e);">
                    <i class="fas fa-seedling fa-2x text-white"></i>
                </div>
                <div class="card-body text-center">
                    <h5 class="card-title fw-bold text-dark mb-2">Semences</h5>
                    <p class="text-muted small mb-3">Disponible semences blé et orge maintenant</p>
                    <a href="{{ path('app_donations_produit', { type: 'semences' }) }}" class="btn btn-demander w-100"><i class="fas fa-hand-holding-heart me-1"></i> Demander</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
