{% extends 'base.html.twig' %}

{% block title %}{{ publication.titre }} - Forum FIRMETNA{% endblock %}

{% block meta %}
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="{{ app.request.uri }}">
    <meta property="og:title" content="{{ publication.titre }} - Forum FIRMETNA">
    <meta property="og:description" content="{{ publication.contenu|u.truncate(200, '...')|striptags }}">
    {% if publication.imageFilename %}
        <meta property="og:image" content="{{ app.request.schemeAndHttpHost ~ asset(publication.imageFilename) }}">
    {% endif %}
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ app.request.uri }}">
    <meta property="twitter:title" content="{{ publication.titre }}">
    <meta property="twitter:description" content="{{ publication.contenu|u.truncate(200, '...')|striptags }}">
    {% if publication.imageFilename %}
        <meta property="twitter:image" content="{{ app.request.schemeAndHttpHost ~ asset(publication.imageFilename) }}">
    {% endif %}
{% endblock %}

{% block body %}
<style>
    body {
        background-color: #f3f0ff !important;
    }

    .forum-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 0;
    }

    .back-btn {
        color: #1a4d2e;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 1.5rem;
        transition: transform 0.2s;
    }
    .back-btn:hover {
        transform: translateX(-5px);
        color: #23613a;
    }

    .pub-card-detail {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 25px rgba(0,0,0,0.08);
        overflow: hidden;
        border: none;
    }

    .pub-header {
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-bottom: 1px solid #f3f4f6;
    }
    .user-profile {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .avatar {
        width: 50px;
        height: 50px;
        background: #1a4d2e;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.3rem;
    }
    .user-info .name {
        font-weight: 700;
        color: #1a1a1b;
        margin: 0;
        font-size: 1.1rem;
    }
    .user-info .meta {
        font-size: 0.85rem;
        color: #6b7280;
        margin: 0;
    }

    .pub-body {
        padding: 2rem 1.5rem;
    }
    .pub-title {
        font-size: 1.75rem;
        font-weight: 800;
        color: #111827;
        margin-bottom: 1.5rem;
    }
    .pub-content {
        font-size: 1.05rem;
        color: #374151;
        line-height: 1.8;
        white-space: pre-wrap;
    }

    .pub-image-full {
        width: 100%;
        border-radius: 10px;
        margin-top: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Comments Section */
    .comments-section {
        margin-top: 3rem;
    }
    .section-title {
        font-weight: 700;
        color: #111827;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .comment-form-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 2rem;
    }

    .comment-card {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        border: 1px solid #f3f4f6;
    }
    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }
    .commenter-name {
        font-weight: 700;
        color: #1a4d2e;
        font-size: 0.95rem;
    }
    .comment-date {
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .pub-actions {
        display: flex;
        gap: 20px;
        padding: 1rem 1.5rem;
        border-top: 1px solid #f3f4f6;
    }
    .pub-action-btn {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 0.95rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.2s;
        cursor: pointer;
    }
    .pub-action-btn:hover {
        background: #f3f4f6;
        color: #1a4d2e;
    }
    .pub-action-btn.liked {
        color: #1a4d2e;
    }
    .pub-action-btn.liked i {
        color: #1a4d2e;
    }

    .comment-reply {
        margin-left: 3rem;
        margin-top: 1rem;
        padding-left: 1rem;
        border-left: 3px solid #e5e7eb;
    }
    .reply-btn {
        background: none;
        border: none;
        color: #1a4d2e;
        font-size: 0.85rem;
        font-weight: 600;
        padding: 4px 8px;
        margin-top: 0.5rem;
        cursor: pointer;
    }
    .reply-btn:hover {
        background: #f3f0ff;
        border-radius: 4px;
    }
    .reply-form {
        margin-top: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        display: none;
    }
    .reply-form.active {
        display: block;
    }

    /* Partage Social */
    .share-section {
        background: #f9fafb;
        border-radius: 10px;
        padding: 1rem;
    }
    .share-buttons .btn {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }
</style>

<div class="container forum-container">
    <a href="{{ path('app_forum') }}" class="back-btn">
        <i class="fas fa-arrow-left"></i> Retour au forum
    </a>

    <article class="pub-card-detail">
        <div class="pub-header">
            <div class="user-profile">
                <div class="avatar">
                    {{ publication.auteur.nom|first|upper ?: publication.auteur.email|first|upper ?: 'U' }}
                </div>
                <div class="user-info">
                    <p class="name">{{ publication.auteur.nom ?: publication.auteur.prenom ?: 'Utilisateur' }}</p>
                    <p class="meta">{{ publication.dateCreation|date('d F Y ├á H:i') }}</p>
                </div>
            </div>
            <span class="badge {{ publication.type == 'idee' ? 'bg-success' : 'bg-danger' }} rounded-pill px-3 py-2">
                {{ publication.getTypeLabel() }}
            </span>
        </div>

        <div class="pub-body">
            <h1 class="pub-title">{{ publication.titre }}</h1>
            <div class="pub-content">{{ publication.contenu }}</div>

            {% if publication.imageFilename %}
                <img src="{{ asset(publication.imageFilename) }}" class="pub-image-full" alt="Illustration">
            {% endif %}

            {% if publication.auteur == app.user or is_granted('ROLE_ADMIN') %}
                <div class="mt-4 pt-4 border-top d-flex gap-3">
                    <a href="{{ path('app_forum_edit', { id: publication.id }) }}" class="btn btn-outline-success rounded-pill px-4">
                        <i class="fas fa-edit me-2"></i>Modifier
                    </a>
                    {{ include('forum/_delete_form.html.twig', { publication: publication }) }}
                </div>
            {% endif %}
        </div>
        <div class="pub-actions">
            {% if app.user %}
                <button class="pub-action-btn like-btn {{ isLiked ? 'liked' : '' }}" data-publication-id="{{ publication.id }}">
                    <i class="{{ isLiked ? 'fas' : 'far' }} fa-thumbs-up"></i>
                    <span class="like-count">{{ publication.likes|length }}</span>
                    <span>J'aime</span>
                </button>
            {% else %}
                <a href="{{ path('app_login') }}" class="pub-action-btn">
                    <i class="far fa-thumbs-up"></i>
                    <span>{{ publication.likes|length }}</span>
                    <span>J'aime</span>
                </a>
            {% endif %}
            <div class="pub-action-btn">
                <i class="far fa-comment"></i>
                <span>{{ publication.commentaires|length }}</span>
                <span>Commentaires</span>
            </div>
        </div>

        <!-- Partage Social -->
        <div class="share-section mt-3 pt-3 border-top">
            <h6 class="mb-3 fw-bold">
                <i class="fas fa-share-alt text-success me-2"></i>Partager cette publication
            </h6>
            <div class="share-buttons d-flex flex-wrap gap-2">
                <a href="{{ shareService.getFacebookShareUrl(publication) }}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="btn btn-sm btn-primary rounded-pill">
                    <i class="fab fa-facebook-f me-1"></i>Facebook
                </a>
                <a href="{{ shareService.getTwitterShareUrl(publication) }}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="btn btn-sm btn-info rounded-pill text-white">
                    <i class="fab fa-twitter me-1"></i>Twitter
                </a>
                <a href="{{ shareService.getWhatsAppShareUrl(publication) }}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="btn btn-sm btn-success rounded-pill">
                    <i class="fab fa-whatsapp me-1"></i>WhatsApp
                </a>
                <a href="{{ shareService.getLinkedInShareUrl(publication) }}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="btn btn-sm btn-primary rounded-pill" style="background-color: #0077b5;">
                    <i class="fab fa-linkedin-in me-1"></i>LinkedIn
                </a>
                <a href="{{ shareService.getEmailShareUrl(publication) }}" 
                   class="btn btn-sm btn-outline-secondary rounded-pill">
                    <i class="fas fa-envelope me-1"></i>Email
                </a>
                <a href="{{ shareService.getInstagramShareUrl(publication) }}" 
                   target="_blank" 
                   rel="noopener noreferrer"
                   class="btn btn-sm rounded-pill" 
                   style="background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: white; border: none;"
                   onclick="copyToClipboard('{{ shareService.getShareUrl(publication) }}'); setTimeout(() => alert('Lien copié ! Ouvrez Instagram et collez-le dans votre story ou post.'), 100);">
                    <i class="fab fa-instagram me-1"></i>Instagram
                </a>
                <button onclick="copyToClipboard('{{ shareService.getShareUrl(publication) }}')" 
                        class="btn btn-sm btn-outline-dark rounded-pill">
                    <i class="fas fa-link me-1"></i>Copier le lien
                </button>
            </div>
        </div>
    </article>

    <div class="comments-section" id="commentaires">
        <h2 class="section-title">
            <i class="fas fa-comments text-success"></i>
            Commentaires ({{ publication.commentaires|length }})
        </h2>

        <div class="comment-form-card">
            <h3 class="h6 fw-bold mb-3">Partager votre avis</h3>
            {{ form_start(form) }}
                {{ form_widget(form.contenu, { 'attr': {'placeholder': 'Écrivez un commentaire...', 'rows': 3, 'class': 'form-control border-0 bg-light rounded-3 p-3'} }) }}
                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-success rounded-pill px-4 fw-bold">
                        <i class="fas fa-paper-plane me-2"></i>Publier le commentaire
                    </button>
                </div>
            {{ form_end(form) }}
        </div>

        <div class="comment-list">
            {% for commentaire in publication.commentaires %}
                {% if not commentaire.parent %}
                    {% set replyForm = replyForms[commentaire.id] ?? form %}
                    {% include 'forum/_comment.html.twig' with {'commentaire': commentaire, 'publication': publication, 'replyForm': replyForm} %}
                {% endif %}
            {% else %}
                <div class="text-center py-5 bg-white rounded-3 shadow-sm opacity-75">
                    <p class="text-muted mb-0">Aucun commentaire pour le moment. Soyez le premier à réagir !</p>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Likes
    const likeBtn = document.querySelector('.like-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', function() {
            const publicationId = this.dataset.publicationId;
            const icon = this.querySelector('i');
            const countSpan = this.querySelector('.like-count');
            
            fetch('{{ path('app_forum_like', {id: '__ID__'}) }}'.replace('__ID__', publicationId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                countSpan.textContent = data.count;
                
                if (data.liked) {
                    this.classList.add('liked');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                } else {
                    this.classList.remove('liked');
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
        });
    }

    // Réponses aux commentaires
    document.querySelectorAll('.reply-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            const form = document.getElementById('reply-form-' + commentId);
            if (form) {
                form.classList.toggle('active');
            }
            });
        });
    });

    // Copier le lien dans le presse-papiers
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Afficher un message de confirmation
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Copié !';
            btn.classList.add('btn-success');
            btn.classList.remove('btn-outline-dark');
            
            setTimeout(function() {
                btn.innerHTML = originalText;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-dark');
            }, 2000);
        }).catch(function(err) {
            console.error('Erreur lors de la copie:', err);
            alert('Impossible de copier le lien');
        });
    }
</script>
{% endblock %}
