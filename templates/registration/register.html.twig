{% extends 'base.html.twig' %}

{% block title %}Inscription - Firmetna{% endblock %}

{% block stylesheets %}
<style>
    :root {
        --primary-green: #1a4d2e;
        --light-green: #f8fafc;
        --text-dark: #111827;
        --text-muted: #6b7280;
        --white: #ffffff;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', sans-serif;
        background-color: var(--white);
    }

    .split-container {
        display: flex;
        min-height: calc(100vh - 70px);
        width: 100%;
    }

    .left-side {
        flex: 1.2;
        background: linear-gradient(rgba(0, 50, 20, 0.4), rgba(0, 50, 20, 0.5)), 
                    url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=1200&h=1600&fit=crop') no-repeat center center;
        background-size: cover;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 6rem 4rem;
        color: white;
        position: relative;
    }

    .left-side h1 {
        font-size: 3.5rem;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 2rem;
        text-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .left-side p {
        font-size: 1.25rem;
        max-width: 500px;
        line-height: 1.6;
        opacity: 0.95;
        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .right-side {
        flex: 1;
        background-color: white;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding: 3rem 4rem;
        overflow-y: auto;
    }

    .register-box {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }

    .register-header {
        margin-bottom: 2rem;
        text-align: center;
    }

    .logo-form-container {
        background-color: white;
        padding: 10px 20px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }

    .form-logo {
        height: 85px;
        width: auto;
    }

    .register-header h2 {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--text-dark);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: -0.5px;
    }

    .register-header p {
        color: var(--text-muted);
        font-weight: 500;
        margin-top: 5px;
    }

    /* Avatar Upload Styling */
    .avatar-upload {
        position: relative;
        max-width: 110px;
        margin: 0 auto 2.5rem auto;
    }
    .avatar-edit {
        position: absolute;
        right: 0;
        z-index: 1;
        top: 0;
    }
    .avatar-preview {
        width: 110px;
        height: 110px;
        position: relative;
        border-radius: 100%;
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .avatar-preview i {
        font-size: 40px;
        color: #d1d5db;
    }
    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .file-input-label {
        display: block;
        width: 30px;
        height: 30px;
        border-radius: 100%;
        background: var(--primary-green);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
        text-align: left;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group.full-width {
        grid-column: span 2;
    }

    .form-label {
        display: block;
        margin-bottom: 0.6rem;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .form-control {
        width: 100%;
        padding: 0.9rem 1.1rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s;
        box-sizing: border-box;
        background-color: #f9fafb;
        color: var(--text-dark);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-green);
        background-color: white;
        box-shadow: 0 0 0 4px rgba(0, 150, 77, 0.05);
    }

    .btn-submit {
        width: 100%;
        padding: 1.1rem;
        background-color: var(--primary-green);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 150, 77, 0.2);
    }

    .btn-submit:hover {
        background-color: #007a3e;
        transform: translateY(-1px);
        box-shadow: 0 6px 15px rgba(0, 150, 77, 0.3);
    }

    .login-footer {
        text-align: center;
        margin-top: 2rem;
        color: var(--text-muted);
        font-size: 0.95rem;
        font-weight: 500;
        padding-bottom: 2rem;
    }

    .login-footer a {
        color: var(--primary-green);
        text-decoration: none;
        font-weight: 700;
    }

    @media (max-width: 1024px) {
        .left-side { display: none; }
        .right-side { flex: 1; padding: 2rem; }
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="split-container">
    <div class="left-side">
        <h1>Rejoignez l'aventure Firmetna</h1>
        <p>Découvrez une nouvelle façon de gérer votre exploitation et de connecter avec votre communauté locale.</p>
    </div>

    <div class="right-side">
        <div class="register-box">
            <div class="register-header">
                <div class="logo-form-container">
                    <img src="{{ asset('images/logo_hand.png') }}" alt="FIRMETNA" class="form-logo">
                </div>
                <h2>CRÉER UN COMPTE</h2>
                <p>Bienvenue parmi nous !</p>
                {{ form_errors(registrationForm) }}
            </div>

            {# Flash Messages #}
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ label == 'danger' ? 'danger' : (label == 'error' ? 'danger' : 'success') }} mb-3" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endfor %}

            {{ form_start(registrationForm, {'attr': {'enctype': 'multipart/form-data'}}) }}
                
                <div class="avatar-upload">
                    <div class="avatar-edit">
                        {{ form_widget(registrationForm.imageFile, {'attr': {'style': 'display: none;', 'onchange': 'previewImage(this)'}}) }}
                        <label for="{{ registrationForm.imageFile.vars.id }}" class="file-input-label">
                            <i class="fas fa-camera"></i>
                        </label>
                    </div>
                    <div class="avatar-preview">
                        <div id="imagePreview">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        {{ form_label(registrationForm.nom, 'Nom', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.nom, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Cherni'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.nom) }}</div>
                    </div>
                    <div class="form-group">
                        {{ form_label(registrationForm.prenom, 'Prénom', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.prenom, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Ranim'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.prenom) }}</div>
                    </div>
                    <div class="form-group full-width">
                        {{ form_label(registrationForm.email, 'Email', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.email, {'attr': {'class': 'form-control', 'placeholder': 'votre@email.com'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.email) }}</div>
                    </div>
                    <div class="form-group">
                        {{ form_label(registrationForm.telephone, 'Téléphone (+216)', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.telephone, {'attr': {'class': 'form-control', 'placeholder': '+216 12345678', 'maxlength': '13'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.telephone) }}</div>
                    </div>
                    <div class="form-group">
                        {{ form_label(registrationForm.roleType, 'Type de compte', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.roleType, {'attr': {'class': 'form-control'}}) }}
                    </div>
                    <div class="form-group full-width">
                        {{ form_label(registrationForm.plainPassword.first, 'Mot de passe', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.plainPassword.first, {'attr': {'class': 'form-control', 'placeholder': '••••••••'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.plainPassword.first) }}</div>
                    </div>
                    <div class="form-group full-width">
                        {{ form_label(registrationForm.plainPassword.second, 'Confirmer le mot de passe', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.plainPassword.second, {'attr': {'class': 'form-control', 'placeholder': '••••••••'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.plainPassword.second) }}</div>
                    </div>
                </div>

                <button type="submit" class="btn-submit">
                    S'inscrire
                </button>
            {{ form_end(registrationForm) }}

            <div class="login-footer">
                Déjà un compte ? <a href="{{ path('app_login') }}">Connectez-vous</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    function previewImage(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var preview = document.getElementById('imagePreview');
                preview.innerHTML = '<img src="' + e.target.result + '" style="width: 100%; height: 100%; object-fit: cover;" />';
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Phone number field logic
    const phoneInput = document.querySelector('input[name*="telephone"]');
    if (phoneInput) {
        // Enforce +216 prefix
        if (!phoneInput.value.startsWith('+216')) {
            phoneInput.value = '+216 ';
        }

        phoneInput.addEventListener('input', function(e) {
            let val = e.target.value;
            
            // Ensure prefix remains
            if (!val.startsWith('+216')) {
                e.target.value = '+216 ';
                return;
            }

            // Remove non-digits after prefix
            let prefix = '+216 ';
            let suffix = val.substring(prefix.length).replace(/\D/g, '');
            
            // Limit to 8 digits
            if (suffix.length > 8) {
                suffix = suffix.substring(0, 8);
            }
            
            e.target.value = prefix + suffix;
        });

        // Prevent deleting prefix
        phoneInput.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && e.target.value.length <= 5) {
                e.preventDefault();
            }
        });
    }
</script>
{% endblock %}
