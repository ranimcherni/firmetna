{% extends 'base.html.twig' %}

{% block title %}Inscription - Firmetna{% endblock %}

{% block stylesheets %}
<style>
    :root {
        --primary-green: #1a4d2e;
        --light-green: #f8fafc;
        --text-dark: #111827;
        --text-muted: #6b7280;
        --white: #ffffff;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', sans-serif;
        background-color: var(--white);
    }

    .split-container {
        display: flex;
        min-height: calc(100vh - 70px);
        width: 100%;
    }

    .left-side {
        flex: 1.2;
        background: linear-gradient(rgba(0, 50, 20, 0.4), rgba(0, 50, 20, 0.5)), 
                    url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=1200&h=1600&fit=crop') no-repeat center center;
        background-size: cover;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        padding: 6rem 4rem;
        color: white;
        position: relative;
    }

    .left-side h1 {
        font-size: 3.5rem;
        font-weight: 800;
        line-height: 1.1;
        margin-bottom: 2rem;
        text-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .left-side p {
        font-size: 1.25rem;
        max-width: 500px;
        line-height: 1.6;
        opacity: 0.95;
        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .right-side {
        flex: 1;
        background-color: white;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding: 3rem 4rem;
        overflow-y: auto;
    }

    .register-box {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }

    .register-header {
        margin-bottom: 2rem;
        text-align: center;
    }

    .logo-form-container {
        background-color: white;
        padding: 10px 20px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }

    .form-logo {
        height: 85px;
        width: auto;
    }

    .register-header h2 {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--text-dark);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: -0.5px;
    }

    .register-header p {
        color: var(--text-muted);
        font-weight: 500;
        margin-top: 5px;
    }

    /* Avatar Upload Styling */
    .avatar-upload {
        position: relative;
        max-width: 110px;
        margin: 0 auto 2.5rem auto;
    }
    .avatar-edit {
        position: absolute;
        right: 0;
        z-index: 1;
        top: 0;
    }
    .avatar-preview {
        width: 110px;
        height: 110px;
        position: relative;
        border-radius: 100%;
        background-color: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
    }
    .avatar-preview i {
        font-size: 40px;
        color: #d1d5db;
    }
    .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .file-input-label {
        display: block;
        width: 30px;
        height: 30px;
        border-radius: 100%;
        background: var(--primary-green);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.25rem;
        text-align: left;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group.full-width {
        grid-column: span 2;
    }

    .form-label {
        display: block;
        margin-bottom: 0.6rem;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .form-control {
        width: 100%;
        padding: 0.9rem 1.1rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        transition: all 0.2s;
        box-sizing: border-box;
        background-color: #f9fafb;
        color: var(--text-dark);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-green);
        background-color: white;
        box-shadow: 0 0 0 4px rgba(0, 150, 77, 0.05);
    }

    .btn-submit {
        width: 100%;
        padding: 1.1rem;
        background-color: var(--primary-green);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 150, 77, 0.2);
    }

    .btn-submit:hover {
        background-color: #007a3e;
        transform: translateY(-1px);
        box-shadow: 0 6px 15px rgba(0, 150, 77, 0.3);
    }

    .login-footer {
        text-align: center;
        margin-top: 2rem;
        color: var(--text-muted);
        font-size: 0.95rem;
        font-weight: 500;
        padding-bottom: 2rem;
    }

    .login-footer a {
        color: var(--primary-green);
        text-decoration: none;
        font-weight: 700;
    }

    /* Switch Styling */
    .form-switch {
        padding-left: 2.5em;
    }
    .form-check-input {
        width: 3em !important;
        height: 1.5em !important;
        margin-left: -2.5em !important;
        cursor: pointer;
    }
    .form-check-input:checked {
        background-color: var(--primary-green);
        border-color: var(--primary-green);
    }
    .face-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        position: relative;
    }

    .face-guide-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 170px;
        height: 190px;
        border: 2px dashed rgba(25, 135, 84, 0.4);
        border-radius: 35px;
        pointer-events: none;
        z-index: 5;
        opacity: 0.7;
    }

    .face-guide-overlay::after {
        content: '';
        width: 100%;
        height: 2px;
        background: rgba(25, 135, 84, 0.3);
        position: absolute;
        box-shadow: 0 0 10px rgba(25, 135, 84, 0.5);
        animation: scan 2.5s infinite ease-in-out;
    }

    @keyframes scan {
        0%, 100% { top: 15%; }
        50% { top: 85%; }
    }
    .text-danger-soft {
        color: #ef4444;
        font-weight: 600;
        font-size: 0.9rem;
    }

    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(26, 77, 46, 0.7); }
        70% { box-shadow: 0 0 0 15px rgba(26, 77, 46, 0); }
        100% { box-shadow: 0 0 0 0 rgba(26, 77, 46, 0); }
    }
    .btn-pulse {
        animation: pulse-green 2s infinite;
        background-color: #198754 !important;
        border-color: #198754 !important;
    }
    .step-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #e2e8f0;
        transition: all 0.3s ease;
    }
    .step-dot.active {
        background-color: var(--primary-green);
        transform: scale(1.3);
        box-shadow: 0 0 8px rgba(26, 77, 46, 0.4);
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block body %}
<div class="split-container">
    <div class="left-side">
        <h1>Rejoignez l'aventure Firmetna</h1>
        <p>Découvrez une nouvelle façon de gérer votre exploitation et de connecter avec votre communauté locale.</p>
    </div>

    <div class="right-side">
        <div class="register-box">
            <div class="register-header">
                <div class="logo-form-container">
                    <img src="{{ asset('images/logo_hand.png') }}" alt="FIRMETNA" class="form-logo">
                </div>
                <h2>CRÉER UN COMPTE</h2>
                <p>Bienvenue parmi nous !</p>
                {{ form_errors(registrationForm) }}
            </div>

            {# Flash Messages #}
            {% for label, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ label == 'danger' ? 'danger' : (label == 'error' ? 'danger' : 'success') }} mb-3" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endfor %}

            {{ form_start(registrationForm, {'attr': {'enctype': 'multipart/form-data'}}) }}
                
                <div class="avatar-upload">
                    <div class="avatar-edit">
                        {{ form_widget(registrationForm.imageFile, {'attr': {'style': 'display: none;', 'onchange': 'previewImage(this)'}}) }}
                        <label for="{{ registrationForm.imageFile.vars.id }}" class="file-input-label">
                            <i class="fas fa-camera"></i>
                        </label>
                    </div>
                    <div class="avatar-preview">
                        <div id="imagePreview">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        {{ form_label(registrationForm.nom, 'Nom', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.nom, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Cherni'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.nom) }}</div>
                    </div>
                    <div class="form-group">
                        {{ form_label(registrationForm.prenom, 'Prénom', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.prenom, {'attr': {'class': 'form-control', 'placeholder': 'Ex: Ranim'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.prenom) }}</div>
                    </div>
                    <div class="form-group full-width">
                        {{ form_label(registrationForm.email, 'Email', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.email, {'attr': {'class': 'form-control', 'placeholder': 'votre@email.com'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.email) }}</div>
                    </div>
                    <div class="form-group">
                        {{ form_label(registrationForm.telephone, 'Téléphone (+216)', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.telephone, {'attr': {'class': 'form-control', 'placeholder': '+216 12345678', 'maxlength': '13'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.telephone) }}</div>
                    </div>
                    <div class="form-group">
                        {{ form_label(registrationForm.roleType, 'Type de compte', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.roleType, {'attr': {'class': 'form-control'}}) }}
                    </div>
                    <div class="form-group full-width">
                        {{ form_label(registrationForm.plainPassword.first, 'Mot de passe', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.plainPassword.first, {'attr': {'class': 'form-control', 'placeholder': '••••••••'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.plainPassword.first) }}</div>
                    </div>
                    <div class="form-group full-width">
                        {{ form_label(registrationForm.plainPassword.second, 'Confirmer le mot de passe', {'label_attr': {'class': 'form-label'}}) }}
                        {{ form_widget(registrationForm.plainPassword.second, {'attr': {'class': 'form-control', 'placeholder': '••••••••'}}) }}
                        <div class="text-danger small">{{ form_errors(registrationForm.plainPassword.second) }}</div>
                    </div>
                </div>

                <!-- Refined Face Recognition Section -->
                <div class="face-recognition-section mb-4">
                    <div class="face-card">
                        <div class="d-flex justify-content-between align-items-center mb-2 text-start">
                            <h6 class="mb-0 fw-bold" style="color: var(--primary-green);">Reconnaissance Faciale (Optionnel)</h6>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="switch-face">
                            </div>
                        </div>
                        <p class="text-muted small text-start mb-3">
                            Activez la connexion par visage pour un accès plus rapide et sécurisé. Aucune photo n'est stockée.
                        </p>

                        <div id="face-ui-container" class="d-none">
                            <div id="ia-status" class="text-primary small fw-bold mb-2 text-center">Initialisation...</div>
                            
                            <!-- Progress Steps -->
                            <div class="d-flex justify-content-center gap-2 mb-3">
                                <div id="step-1" class="step-dot active"></div>
                                <div id="step-2" class="step-dot"></div>
                                <div id="step-3" class="step-dot"></div>
                            </div>
                            <div id="step-instruction" class="text-center small fw-bold mb-2 text-muted">ÉTAPE 1 : Regardez l'écran bien en face</div>

                            <div class="video-container position-relative mx-auto mb-3" style="width: 280px; height: 210px; background: #000; border-radius: 12px; overflow: hidden; border: 3px solid var(--primary-green);">
                                <video id="video" style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);" autoplay muted></video>
                                <canvas id="overlay" class="position-absolute start-0 top-0" style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); pointer-events: none;"></canvas>
                                <div class="face-guide-overlay"></div>
                            </div>
                            
                            <div id="scan-status" class="alert p-2 small d-none mb-3"></div>
                            <div id="detection-msg" class="alert alert-warning p-2 small mb-3 d-none"></div>

                            <button type="button" id="btn-capture-face" class="btn btn-outline-success w-100 py-2 fw-bold" disabled>
                                <i class="fas fa-camera me-2"></i>Capturer (<span id="capture-count">0</span>/3)
                            </button>
                        </div>
                    </div>
                    {{ form_row(registrationForm.faceSignature) }}
                </div>

                <div class="mb-4 d-flex justify-content-center">
                    <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
                </div>

                <button type="submit" class="btn-submit">
                    S'inscrire
                </button>
            {{ form_end(registrationForm) }}

            <script src="https://www.google.com/recaptcha/api.js" async defer></script>

            <div class="login-footer">
                Déjà un compte ? <a href="{{ path('app_login') }}">Connectez-vous</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<!-- Face-API.js -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const loadingModels = document.getElementById('loading-models');
        const scanStatus = document.getElementById('scan-status');
        const faceSignatureInput = document.getElementById('registration_form_faceSignature');
        const submitBtn = document.querySelector('.btn-submit');
        const switchFace = document.getElementById('switch-face');
        const btnCaptureFace = document.getElementById('btn-capture-face');
        const faceUIContainer = document.getElementById('face-ui-container');
        const detectionMsg = document.getElementById('detection-msg');
        const iaStatus = document.getElementById('ia-status');

        const captureCountText = document.getElementById('capture-count');
        const stepInstruction = document.getElementById('step-instruction');
        const dots = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];

        let modelsLoaded = false;
        let detectionsActive = false;
        let recognitionInterval = null;
        let capturedDescriptors = [];
        const STEPS = [
            "Regardez l'écran bien en face",
            "Tournez légèrement la tête vers la GAUCHE",
            "Tournez légèrement la tête vers la DROITE"
        ];

        const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';

        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera access error:", err);
                detectionMsg.textContent = "Caméra bloquée ou inaccessible.";
                detectionMsg.classList.remove('d-none');
            }
        }

        function stopVideo() {
            detectionsActive = false;
            if (recognitionInterval) clearInterval(recognitionInterval);
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
        }

        async function runRecognitionLoop() {
            if (recognitionInterval) clearInterval(recognitionInterval);
            if (!modelsLoaded || video.readyState < 2) {
                setTimeout(runRecognitionLoop, 500);
                return;
            }

            detectionsActive = true;
            iaStatus.textContent = "IA EN ATTENTE DU VISAGE...";
            iaStatus.className = "text-primary fw-bold mb-2 text-center";

            overlay.style.zIndex = "100";
            overlay.style.display = "block";
            const ctx = overlay.getContext('2d');

            recognitionInterval = setInterval(async () => {
                if (!detectionsActive || video.paused || video.ended) return;

                try {
                    // 1. DRAW GUIDE & HEARTBEAT
                    ctx.clearRect(0, 0, overlay.width, overlay.height);
                    
                    // The Target Oval
                    ctx.strokeStyle = '#FF007F55';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.ellipse(overlay.width/2, overlay.height/2, 80, 110, 0, 0, 2*Math.PI);
                    ctx.stroke();

                    // Pink Heartbeat
                    if (Math.floor(Date.now() / 400) % 2 === 0) {
                        ctx.fillStyle = '#FF007F'; 
                        ctx.beginPath(); ctx.arc(20, 20, 6, 0, 2*Math.PI); ctx.fill();
                    }

                    // 2. DETECT (Facile Mode: 160px input)
                    const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.1 }))
                        .withFaceLandmarks();

                    if (result) {
                        const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
                        if (overlay.width !== displaySize.width) {
                            overlay.width = displaySize.width;
                            overlay.height = displaySize.height;
                            faceapi.matchDimensions(overlay, displaySize);
                        }
                        
                        const resizedResult = faceapi.resizeResults(result, displaySize);
                        
                        // DRAW LANDMARKS (8px XXL)
                        ctx.fillStyle = '#FF007F'; 
                        resizedResult.landmarks.positions.forEach(p => {
                            ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, 2 * Math.PI); ctx.fill();
                        });

                        const score = Math.round(result.detection.score * 100);
                        iaStatus.textContent = `VISAGE TROUVÉ (${score}%)`;
                        iaStatus.className = "text-success fw-bold mb-2 text-center";
                        btnCaptureFace.disabled = false;
                        btnCaptureFace.classList.add('btn-pulse', 'btn-success');
                    } else {
                        iaStatus.textContent = "POSITIONNEZ VOTRE VISAGE DANS L'OVALE";
                        iaStatus.className = "text-muted small mb-2 text-center";
                        btnCaptureFace.disabled = true;
                        btnCaptureFace.classList.remove('btn-pulse', 'btn-success');
                    }
                } catch (err) {
                    console.error("Scanner Error:", err);
                }
            }, 100); 
        }

        switchFace.addEventListener('change', async (e) => {
            if (e.target.checked) {
                faceUIContainer.classList.remove('d-none');
                if (!modelsLoaded) {
                    iaStatus.textContent = "TÉLÉCHARGEMENT DE L'IA...";
                    try {
                        const baseUrl = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights';
                        await faceapi.nets.tinyFaceDetector.loadFromUri(baseUrl);
                        iaStatus.textContent = "CHARGEMENT RÉSEAU 1/4...";
                        await faceapi.nets.faceLandmark68Net.loadFromUri(baseUrl);
                        iaStatus.textContent = "CHARGEMENT RÉSEAU 2/4...";
                        await faceapi.nets.faceRecognitionNet.loadFromUri(baseUrl);
                        iaStatus.textContent = "CHARGEMENT RÉSEAU 3/4...";
                        await faceapi.nets.ssdMobilenetv1.loadFromUri(baseUrl);
                        
                        modelsLoaded = true;
                        iaStatus.textContent = "IA PRÊTE À 100%";
                        iaStatus.className = "text-success fw-bold mb-2 text-center";
                        startVideo();
                    } catch (err) {
                        console.error("Models failed:", err);
                        iaStatus.textContent = "ERREUR DE RÉSEAU (Vérifiez votre connexion)";
                        iaStatus.className = "text-danger small fw-bold mb-2 text-center";
                    }
                } else {
                    startVideo();
                }
            } else {
                stopVideo();
                faceUIContainer.classList.add('d-none');
                faceSignatureInput.value = '';
                capturedDescriptors = [];
                updateCaptureUI();
            }
        });

        function updateCaptureUI() {
            const count = capturedDescriptors.length;
            captureCountText.textContent = count;
            
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === count);
                dot.classList.toggle('bg-success', i < count);
            });

            if (count < 3) {
                stepInstruction.textContent = "ÉTAPE " + (count + 1) + " : " + STEPS[count];
            }
        }

        btnCaptureFace.addEventListener('click', async (e) => {
            e.preventDefault();
            if (capturedDescriptors.length >= 3) return;

            btnCaptureFace.disabled = true;
            iaStatus.textContent = "Analyse en cours...";

            try {
                const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options())
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                if (detection) {
                    capturedDescriptors.push(detection.descriptor);
                    updateCaptureUI();

                    if (capturedDescriptors.length === 3) {
                        // Calculate mean descriptor
                        const meanDescriptor = new Float32Array(128);
                        for (let i = 0; i < 128; i++) {
                            meanDescriptor[i] = (capturedDescriptors[0][i] + capturedDescriptors[1][i] + capturedDescriptors[2][i]) / 3;
                        }
                        
                        faceSignatureInput.value = JSON.stringify(Array.from(meanDescriptor));
                        iaStatus.textContent = "SIGNATURE COMPLÈTE !";
                        iaStatus.className = "text-success fw-bold mb-2 text-center";
                        stopVideo();
                        btnCaptureFace.classList.add('d-none');
                        scanStatus.className = "alert alert-success p-3 text-center";
                        scanStatus.innerHTML = "<i class='fas fa-check-circle me-2'></i> Signature générée avec succès.";
                        scanStatus.classList.remove('d-none');
                    } else {
                        iaStatus.textContent = "Captureréussie ! Étape suivante...";
                        setTimeout(runRecognitionLoop, 500);
                    }
                } else {
                    alert("Visage non détecté. Assurez-vous d'être bien éclairé.");
                }
            } catch (err) {
                console.error("Capture error:", err);
            }
        });

        video.addEventListener('play', runRecognitionLoop);
    });

    // Phone prefix logic
    const phoneInput = document.querySelector('input[name*="telephone"]');
    if (phoneInput) {
        if (!phoneInput.value.startsWith('+216')) phoneInput.value = '+216 ';
        phoneInput.addEventListener('input', function(e) {
            let val = e.target.value;
            if (!val.startsWith('+216')) { e.target.value = '+216 '; return; }
            let suffix = val.substring(5).replace(/\D/g, '');
            if (suffix.length > 8) suffix = suffix.substring(0, 8);
            e.target.value = '+216 ' + suffix;
        });
    }
</script>
{% endblock %}
